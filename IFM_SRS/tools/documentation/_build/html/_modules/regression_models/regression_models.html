

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>regression_models.regression_models &#8212; Model Fits Tools  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/regression_models/regression_models';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Model Fits Tools  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for regression_models.regression_models</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (C) 2023-2024, Bayerische Motoren Werke Aktiengesellschaft (BMW AG)</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">ModelDesc</span><span class="p">,</span> <span class="n">dmatrices</span><span class="p">,</span> <span class="n">dmatrix</span>
<span class="kn">from</span> <span class="nn">patsy.desc</span> <span class="kn">import</span> <span class="n">Term</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">null_space</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">statsmodels.base.model</span> <span class="kn">import</span> <span class="n">GenericLikelihoodModel</span>
<span class="kn">from</span> <span class="nn">statsmodels.regression.linear_model</span> <span class="kn">import</span> <span class="n">RegressionResultsWrapper</span>
<span class="kn">from</span> <span class="nn">tools.general_utility.helpers</span> <span class="kn">import</span> <span class="n">NR_OF_DIGITS_AFTER_COMMA</span><span class="p">,</span> <span class="n">display_dataframe</span><span class="p">,</span> <span class="n">display_markdown</span><span class="p">,</span> <span class="n">get_now_string</span>
<span class="kn">from</span> <span class="nn">tools.marginal_distributions.marginal_distributions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConvenientMarginalDistributionFitSciPyFrozen</span><span class="p">,</span>
    <span class="n">find_best_fit</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tools.models_export.statsmodels_exporter</span> <span class="kn">import</span> <span class="n">SpmModel</span>
<span class="kn">from</span> <span class="nn">tools.plot_tools.plot_tools</span> <span class="kn">import</span> <span class="n">plot_hist_and_fit</span><span class="p">,</span> <span class="n">qqplot</span>
<span class="kn">from</span> <span class="nn">tools.regression_models.regression_helpers</span> <span class="kn">import</span> <span class="n">generate_test_data</span><span class="p">,</span> <span class="n">predict_statsmodels</span>
<span class="kn">from</span> <span class="nn">tools.remove_invalid_sessions.remove_invalid_sessions</span> <span class="kn">import</span> <span class="n">TotalFailureInfo</span>

<span class="n">OUTPUT_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;./models/&quot;</span>
<span class="n">CB_ID_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9a-zA-Z_]+_[0-9]{7,}[a-zA-Z]?&quot;</span>
<span class="n">LINES_SEPARATOR</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-----------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="ConvenientRegressionFit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit">[docs]</a><span class="k">class</span> <span class="nc">ConvenientRegressionFit</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An abstract class to fit regressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    scenario_name : str</span>
<span class="sd">        Name of the scenario.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Regression formula.</span>
<span class="sd">    timestamp_input_data : str or None</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None</span>
<span class="sd">        Timestamp of the model export.</span>
<span class="sd">    total_failure_info : TotalFailureInfo or None</span>
<span class="sd">        Total failure info received from remove_invalid_sessions.</span>
<span class="sd">    inverse_output_trafo : Callable or None, optional</span>
<span class="sd">        Inverse output transformation of the SPV.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Model formula.</span>
<span class="sd">    inverse_output_trafo : Callable or None</span>
<span class="sd">        Inverse output transformation of the SPV.</span>
<span class="sd">    response_name : str</span>
<span class="sd">        Name of the SPV.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    residual_write_file : str</span>
<span class="sd">        Path to the csv of residuals.</span>
<span class="sd">    model_write_file : str</span>
<span class="sd">        Path to the model.json file.</span>
<span class="sd">    tests_write_file : str</span>
<span class="sd">        Path to the tests.json file.</span>
<span class="sd">    timestamp_input_data : str or None</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None</span>
<span class="sd">        Timestamp of the model export.</span>
<span class="sd">    posterior_total_failure_probability : float</span>
<span class="sd">        Posterior total failure probability.</span>
<span class="sd">    observed_total_failures : int</span>
<span class="sd">        Observed total failures.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timestamp_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timestamp_export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">total_failure_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TotalFailureInfo</span><span class="p">],</span>
        <span class="n">inverse_output_trafo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are nan values in the data frame!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cb_ids_in_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>  <span class="c1"># This is only used to bring the test vector data into the right form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span> <span class="o">=</span> <span class="n">inverse_output_trafo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_write_file</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_extreme_resids.csv&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_write_file</span> <span class="o">=</span> <span class="n">OUTPUT_FOLDER</span> <span class="o">+</span> <span class="n">scenario_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_model.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span> <span class="o">=</span> <span class="n">OUTPUT_FOLDER</span> <span class="o">+</span> <span class="n">scenario_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_tests.json&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span> <span class="o">=</span> <span class="n">timestamp_input_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="o">=</span> <span class="n">timestamp_export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posterior_total_failure_probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observed_total_failures</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">total_failure_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior_total_failure_probability</span> <span class="o">=</span> <span class="n">total_failure_info</span><span class="o">.</span><span class="n">posterior_total_failure_probability</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observed_total_failures</span> <span class="o">=</span> <span class="n">total_failure_info</span><span class="o">.</span><span class="n">observed_total_failures</span>

    <span class="k">def</span> <span class="nf">_check_cb_ids_in_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spvs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">lhs_termlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spv</span> <span class="ow">in</span> <span class="n">spvs</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
                <span class="n">spv_name</span> <span class="o">=</span> <span class="n">spv</span><span class="o">.</span><span class="n">code</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">CB_ID_REGEX</span><span class="p">,</span> <span class="n">spv_name</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Codebeamer ID missing in SPV </span><span class="si">{</span><span class="n">spv_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ifvs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">rhs_termlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ifv</span> <span class="ow">in</span> <span class="n">ifvs</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
                <span class="n">ifv_name</span> <span class="o">=</span> <span class="n">ifv</span><span class="o">.</span><span class="n">code</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">CB_ID_REGEX</span><span class="p">,</span> <span class="n">ifv_name</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Codebeamer ID missing in IFV </span><span class="si">{</span><span class="n">ifv_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">noise_dist_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str : Name of the noise distribution.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_fit_noise_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_return_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">RegressionResultsWrapper</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">predictors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List[str] : List of the predictors of the model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="n">ConvenientRegressionFit</span><span class="o">.</span><span class="n">__remove_category_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;np.array : The leverage of the design matrix.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">))</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">H</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loocv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;float : The leave one out cross validation error.&quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_predict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y_predict&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_predict</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">h</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_endog_part_of_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_response_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">endog_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endog_part_of_formula</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([a-zA-Z_]+\.)?(.+)\((.+)\)&quot;</span><span class="p">,</span> <span class="n">endog_part</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># remove the .</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only numpy functions are supported&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2"> found in numpy&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_inverse_output_trafo</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid input format for working with an inverse output trafo. Valid format np.log(var_name)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">endog_part</span>

    <span class="k">def</span> <span class="nf">_check_inverse_output_trafo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_trafo</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100_000</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>  <span class="c1"># As we don&#39;t know the support of output_trafo, this might raise some warnings which we can suppress</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">trafo_data</span> <span class="o">=</span> <span class="n">output_trafo</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
                <span class="c1"># remove nan values, since the output_trafo is not defined for those values</span>
                <span class="n">remaining_trafo_data</span> <span class="o">=</span> <span class="n">trafo_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trafo_data</span><span class="p">)]</span>
                <span class="n">remaining_test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">trafo_data</span><span class="p">)]</span>
                <span class="n">inverse_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">(</span><span class="n">remaining_trafo_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">inverse_data</span><span class="p">,</span> <span class="n">remaining_test_data</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The given function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="si">}</span><span class="s2"> is not the inverse of the transformation function </span><span class="si">{</span><span class="n">output_trafo</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="ConvenientRegressionFit.print_summary"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.print_summary">[docs]</a>    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints a summary of the model.&quot;&quot;&quot;</span>
        <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_residuals"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the residuals in a scatter plot.&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;y_predict&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_residuals_hist"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_residuals_hist">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the residuals in a histogram plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nbins : int, optional</span>
<span class="sd">            Number of bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">,</span>
            <span class="n">nbins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span>
            <span class="n">histnorm</span><span class="o">=</span><span class="s2">&quot;probability density&quot;</span><span class="p">,</span>
            <span class="n">marginal</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_residuals_dist_hist"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_residuals_dist_hist">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals_dist_hist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x_limits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">bcumulative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots a histogram of the residuals together with the pdf or cdf of the fitted residual distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_limits : List[float], optional</span>
<span class="sd">            Range of the x-axis to be plotted.</span>
<span class="sd">        nbins : int, optional</span>
<span class="sd">            Number of bins.</span>
<span class="sd">        bcumulative : bool, optional</span>
<span class="sd">            Whether the cumulative distribution function or the probability density function should be plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_hist_and_fit</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span> <span class="n">x_lim</span><span class="o">=</span><span class="n">x_limits</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="n">bcumulative</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.resid_qqplot"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.resid_qqplot">[docs]</a>    <span class="k">def</span> <span class="nf">resid_qqplot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the residuals in a qq-plot.&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">qqplot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">],</span>
            <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;QQ-Plot of residuals for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_set_figure_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">all_axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> : </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> : </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_partregress_grid"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_partregress_grid">[docs]</a>    <span class="k">def</span> <span class="nf">plot_partregress_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">figpad</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates all partial regression plots of the model (SPM vs one regressor).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : Tuple[int, int], optional</span>
<span class="sd">            Size of the figure.</span>
<span class="sd">        figpad : float, optional</span>
<span class="sd">            Padding between the figure edge and the edges of subplots, as a fraction of the font size.</span>
<span class="sd">        fontsize : float, optional</span>
<span class="sd">            Size of the font.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_partregress_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_figure_axes</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="n">figpad</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_ccpr_grid"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_ccpr_grid">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ccpr_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">figpad</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates a grid of component and component-plus-residual (CCPR) plots.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : Tuple[int, int], optional</span>
<span class="sd">            Size of the figure.</span>
<span class="sd">        figpad : float, optional</span>
<span class="sd">            Padding between the figure edge and the edges of subplots, as a fraction of the font size.</span>
<span class="sd">        fontsize : float, optional</span>
<span class="sd">            Size of the font.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">plot_ccpr_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_figure_axes</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="n">figpad</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_model_vs_original"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_model_vs_original">[docs]</a>    <span class="k">def</span> <span class="nf">plot_model_vs_original</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visual plausibility check of the model, where the model output is random samples from the model for given regressor values in the origin data and the original output is samples of the independent variable in the original data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Seed for the model prediction.</span>
<span class="sd">        n : int or None, optional</span>
<span class="sd">            Number of samples to plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_prediction</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">n_points_to_plot</span> <span class="o">=</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_points_to_plot</span> <span class="o">&gt;</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can only plot a maximum of </span><span class="si">{</span><span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> points. Requested number of points: </span><span class="si">{</span><span class="n">n_points_to_plot</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">number_of_df_columns</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">number_of_df_columns</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">regressors</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;model_output&quot;</span><span class="p">,</span> <span class="s2">&quot;y_predict&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regressors</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span> <span class="n">n_points_to_plot</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">x</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                    <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span>
                    <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_standardized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Identify numerical columns in the DataFrame</span>
        <span class="c1"># Notice that we may not scale the response variable!</span>
        <span class="n">cols_to_be_standardized</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># Scale only the numerical columns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_be_standardized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="n">cols_to_be_standardized</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cols_to_be_standardized</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_get_fitted_standardized_data_coefficients_and_confidence_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_fit</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_standardized_data</span><span class="p">)</span>
        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span>
        <span class="n">conf_int</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span>  <span class="c1"># 95% confidence intervals</span>

        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">coefficients</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">],</span> <span class="n">conf_int</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">])</span>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_standardized_coefficients"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_standardized_coefficients">[docs]</a>    <span class="k">def</span> <span class="nf">plot_standardized_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots standardized coefficients in a horizontal bar plot.&quot;&quot;&quot;</span>
        <span class="n">coefficients</span><span class="p">,</span> <span class="n">confidence_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fitted_standardized_data_coefficients_and_confidence_intervals</span><span class="p">()</span>

        <span class="c1"># Plot the parameter output with confidence intervals (horizontal bar plot)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

        <span class="c1"># Plot the horizontal bars for coefficients</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">coefficients</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">coefficients</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="n">coefficients</span> <span class="o">-</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coefficients</span><span class="p">),</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">ecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Coefficient Value&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Increase the font size for tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_fit</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">resid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y_predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fittedvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_noise_dist</span><span class="p">()</span>

<div class="viewcode-block" id="ConvenientRegressionFit.drop_term"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.drop_term">[docs]</a>    <span class="k">def</span> <span class="nf">drop_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drops the given term from the formula and refits the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        term : str</span>
<span class="sd">            Term to drop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">term</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.print_p_sorted_terms"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.print_p_sorted_terms">[docs]</a>    <span class="k">def</span> <span class="nf">print_p_sorted_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the sorted p-values of the model.&quot;&quot;&quot;</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">p_values</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.is_predictor_hierarchically_dependent"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.is_predictor_hierarchically_dependent">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_predictor_hierarchically_dependent</span><span class="p">(</span><span class="n">predictor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">predictors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns if the predictor is hierarchically dependent on the list of predictors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictor : str</span>
<span class="sd">            Predictor to be analyzed for hierarchical dependency</span>
<span class="sd">        predictors : List[str]</span>
<span class="sd">            List of predictors</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            If the predictor is hierarchically dependent on the predictors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__is_subterm</span><span class="p">(</span><span class="n">potential_subterm</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span> <span class="n">potential_superterm</span><span class="o">=</span><span class="n">potential_superterm</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">potential_superterm</span> <span class="ow">in</span> <span class="n">predictors</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__is_subterm_of_other_terms_with_lower_value</span><span class="p">(</span>
        <span class="n">term_to_check</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_to_term_to_check</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">other_terms</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">other_terms</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">other_term</span><span class="p">,</span> <span class="n">other_value</span> <span class="ow">in</span> <span class="n">other_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__is_subterm</span><span class="p">(</span><span class="n">potential_subterm</span><span class="o">=</span><span class="n">term_to_check</span><span class="p">,</span> <span class="n">potential_superterm</span><span class="o">=</span><span class="n">other_term</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">other_value</span> <span class="o">&lt;</span> <span class="n">value_to_term_to_check</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__is_subterm</span><span class="p">(</span><span class="n">potential_subterm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">potential_superterm</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Checks if all elements of list1 are contained in list2 with the same occurrence ignoring categories</span>
        <span class="n">list1</span> <span class="o">=</span> <span class="n">potential_subterm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">list2</span> <span class="o">=</span> <span class="n">potential_superterm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">list1_without_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__remove_category_from_string</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">list1</span><span class="p">]</span>
        <span class="n">list2_without_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__remove_category_from_string</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">]</span>
        <span class="c1"># Hint: The occurrence is important for terms like &quot;A*A*B&quot;</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">list1_without_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">list1_without_categories</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list2_without_categories</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__remove_category_from_string</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*?\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

<div class="viewcode-block" id="ConvenientRegressionFit.least_significant"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.least_significant">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">least_significant</span><span class="p">(</span><span class="n">p_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the least significant term without categories and the p-value of said term.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p_values : pd.Series</span>
<span class="sd">            Series of p-values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[str, float]</span>
<span class="sd">            Tuple of least significant term and its p-value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract elements that are not subterms of any other term</span>
        <span class="n">removable_p_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">p_value</span> <span class="ow">in</span> <span class="n">p_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__is_subterm_of_other_terms_with_lower_value</span><span class="p">(</span>
                <span class="n">term_to_check</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">value_to_term_to_check</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span> <span class="n">other_terms</span><span class="o">=</span><span class="n">p_values</span>
            <span class="p">):</span>
                <span class="n">removable_p_values</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">term</span><span class="p">:</span> <span class="n">p_value</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removable_p_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">least_significant_term</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">removable_p_values</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="c1"># Remove [T.xxx] and return with p-value</span>
        <span class="n">least_significant_term_without_categories</span> <span class="o">=</span> <span class="n">ConvenientOlsFit</span><span class="o">.</span><span class="n">__remove_category_from_string</span><span class="p">(</span>
            <span class="n">least_significant_term</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">least_significant_term_without_categories</span><span class="p">,</span>
            <span class="n">removable_p_values</span><span class="p">[</span><span class="n">least_significant_term</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.backward_elimination"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.backward_elimination">[docs]</a>    <span class="k">def</span> <span class="nf">backward_elimination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs backward elimination on the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">            Threshold for the backward elimination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">linear_combinations</span> <span class="o">=</span> <span class="n">_get_linearly_dependent_predictors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Intercept&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">linear_combinations</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Some of the predictors are linearly dependent, which is not allowed in OLS regression. See:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">LINES_SEPARATOR</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">linear_combinations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">sorted_p_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df_log</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="n">step</span><span class="p">:</span> <span class="n">sorted_p_values</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)},</span> <span class="n">index</span><span class="o">=</span><span class="n">sorted_p_values</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># tolist required?</span>

        <span class="n">term</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">least_significant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">p_value</span> <span class="o">&gt;=</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_term</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="n">new_pvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span>
            <span class="n">term</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">least_significant</span><span class="p">(</span><span class="n">new_pvalues</span><span class="p">)</span>
            <span class="n">df_log</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_pvalues</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df_log</span> <span class="o">=</span> <span class="n">df_log</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">df_log</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Remove index label</span>
        <span class="n">display</span><span class="p">(</span><span class="n">df_log</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.combine_categories"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.combine_categories">[docs]</a>    <span class="k">def</span> <span class="nf">combine_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">categories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">combined_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combines the categories for the given column name of the IFV DataFrame and fits the model again.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        column_name : str</span>
<span class="sd">            Column name in the IFV DataFrame.</span>
<span class="sd">        categories : List[str]</span>
<span class="sd">            List of categories.</span>
<span class="sd">        combined_category : str</span>
<span class="sd">            Name of the combined category.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">combined_category</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.print_outlier_session_ids"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.print_outlier_session_ids">[docs]</a>    <span class="k">def</span> <span class="nf">print_outlier_session_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">csv_export</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints outlier session IDs and writes session IDs with extreme residuals to a file if specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int, optional</span>
<span class="sd">            Number of session IDs to print.</span>
<span class="sd">        ascending : bool, optional</span>
<span class="sd">            Wether to sort the IFV DataFrame in ascending or descending order.</span>
<span class="sd">        csv_export : bool, optional</span>
<span class="sd">            Wether to export the session IDs with extreme residuals as a csv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;resid&quot;</span><span class="p">]]</span>  <span class="c1"># Move resid column to the front</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">csv_export</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_write_file</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session IDs with extreme residuals written to &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.export_model"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.export_model">[docs]</a>    <span class="k">def</span> <span class="nf">export_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr_of_digits_after_comma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">NR_OF_DIGITS_AFTER_COMMA</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports the model as a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nr_of_digits_after_comma : int or None, optional</span>
<span class="sd">            Number of digits after the comma in the json file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_write_file</span><span class="p">))</span>
        <span class="n">SpmModel</span><span class="o">.</span><span class="n">from_linear_model_result</span><span class="p">(</span>
            <span class="n">model_result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">,</span>
            <span class="n">total_failure_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior_total_failure_probability</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span><span class="p">,</span>
            <span class="n">custom_noise_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_write_file</span><span class="p">,</span> <span class="n">nr_of_digits_after_comma</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model written to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_write_file</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="ow">or</span> <span class="n">get_now_string</span><span class="p">()))</span></div>

    <span class="k">def</span> <span class="nf">__formula_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Use right hand side of formula (y ~ (this part))</span>

<div class="viewcode-block" id="ConvenientRegressionFit.export_tests"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.export_tests">[docs]</a>    <span class="k">def</span> <span class="nf">export_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and exports tests for the model as a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_data : Dict[str, List[Any]]</span>
<span class="sd">            Input data to generate the tests.</span>
<span class="sd">        seed : str</span>
<span class="sd">            Seed for generating the tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__formula_rhs</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">generate_test_data</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span>
            <span class="n">dmatrix</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">inv_trafo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">,</span>
            <span class="n">noise_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Either input data timestamp or export timestamp was not provided while exporting tests&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests written to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="ow">or</span> <span class="n">get_now_string</span><span class="p">()))</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__reduce_rows_keeping_rank</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_columns</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">reduced_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_columns</span><span class="p">))</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
            <span class="c1"># Temporary add new row</span>
            <span class="n">temp_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">reduced_matrix</span><span class="p">,</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">temp_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">temp_matrix</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">temp_rank</span> <span class="o">&gt;</span> <span class="n">rank</span><span class="p">:</span>
                <span class="c1"># Keep if rank is increased</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">reduced_matrix</span> <span class="o">=</span> <span class="n">temp_matrix</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">temp_rank</span>

            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">num_columns</span><span class="p">:</span>
                <span class="c1"># Break if full rank is already achieved</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">rank</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reduced_matrix</span>

<div class="viewcode-block" id="ConvenientRegressionFit.factor_names_from_formula"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.factor_names_from_formula">[docs]</a>    <span class="k">def</span> <span class="nf">factor_names_from_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the factor names from the formula.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[str], List[str]]</span>
<span class="sd">            Tuple of terms of the left hand side and right hand side.</span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function cannot extract variables from expressions like &quot;np.power(x1,2)&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Caveat: cannot extract variables from expressions like &quot;np.power(x1,2)&quot;</span>

        <span class="c1"># X_temp = dmatrix(self.__formula_rhs(), data=data, return_type=&quot;dataframe&quot;)</span>
        <span class="c1"># return [</span>
        <span class="c1">#     factor_info.code for factor_info in X_temp.design_info.factor_infos</span>
        <span class="c1"># ]  # see https://patsy.readthedocs.io/en/latest/API-reference.html#patsy.FactorInfo</span>
        <span class="k">def</span> <span class="nf">get_params_from_terms</span><span class="p">(</span><span class="n">term_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Term</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">({</span><span class="n">factor</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">term_list</span> <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">factors</span> <span class="k">if</span> <span class="n">factor</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Intercept&quot;</span><span class="p">})</span>
            <span class="p">)</span>

        <span class="n">model_description</span> <span class="o">=</span> <span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_params_from_terms</span><span class="p">(</span><span class="n">model_description</span><span class="o">.</span><span class="n">lhs_termlist</span><span class="p">),</span> <span class="n">get_params_from_terms</span><span class="p">(</span>
            <span class="n">model_description</span><span class="o">.</span><span class="n">rhs_termlist</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.export_tests_from_input_data"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.export_tests_from_input_data">[docs]</a>    <span class="k">def</span> <span class="nf">export_tests_from_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">,</span> <span class="n">substitute_columns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Substitutes columns in the regression formula and exports a test json-file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seed : str, optional</span>
<span class="sd">            Seed for test data generation</span>
<span class="sd">        substitute_columns : Dict[str, str], optional</span>
<span class="sd">            Dictionary for which the keys are the old and the values the new factor names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This part needs refactoring and tests!</span>
        <span class="c1"># Add column is a workaround when you have expressions like &quot;np.power(x1,2)&quot;&quot;.</span>
        <span class="c1"># I (Moritz) did not find a way how to extract &quot;x1&quot; easily from the design matrix.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">test_rows_indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce_rows_keeping_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">test_rows_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_rows_indices</span><span class="p">]</span>

        <span class="c1"># Reduce Design Matrix to these rows...</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">factor_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_names_from_formula</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">substitute_columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">substitute_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">factor_names</span><span class="p">:</span>
                    <span class="n">index_to_replace</span> <span class="o">=</span> <span class="n">factor_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
                    <span class="n">factor_names</span><span class="p">[</span><span class="n">index_to_replace</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> was not found in the regression formula!&quot;</span><span class="p">)</span>

        <span class="n">factor_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">factor_names</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>

        <span class="c1"># ... and also the original data frame</span>
        <span class="n">test_rows_dataframe</span> <span class="o">=</span> <span class="n">test_rows_dataframe</span><span class="p">[</span><span class="n">factor_names</span><span class="p">]</span>  <span class="c1"># Take only columns that are found in the Design Matrix</span>

        <span class="c1"># use this instead: patsy.ModelDesc.from_formula</span>
        <span class="n">formula_rhs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__formula_rhs</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># Use right hand side of formula (y ~ (this part)), TODO: Use design_info.factor_infos instead!</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span><span class="n">formula_rhs</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">test_rows_dataframe</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">generate_test_data</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="n">test_rows_dataframe</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">),</span>
            <span class="n">dmatrix</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">inv_trafo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">,</span>
            <span class="n">noise_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_file</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__create_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_input_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Either input data timestamp or export timestamp was not provided while exporting tests from input data&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests written to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests_write_file</span> <span class="o">+</span> <span class="s2">&quot; on &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_export</span> <span class="ow">or</span> <span class="n">get_now_string</span><span class="p">()))</span>

<div class="viewcode-block" id="ConvenientRegressionFit.to_marginal_distribution"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.to_marginal_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">to_marginal_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConvenientMarginalDistributionFitSciPyFrozen</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the model to a frozen marginal distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ConvenientMarginalDistributionFitSciPyFrozen</span>
<span class="sd">            Frozen marginal distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConvenientMarginalDistributionFitSciPyFrozen</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;resid_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_display_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary for Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;General information:&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">:</span>
            <span class="n">display_markdown</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This model predicts </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_endog_part_of_formula</span><span class="si">}</span><span class="s2">. To get the value for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="si">}</span><span class="s2">, the output needs to be transformed with np.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">().&quot;</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">display_dataframe</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;Property&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Number of observations&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;R-Squared&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;R-Squared adj.&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Noise distribution&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Posterior total failure probability with uniform prior&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Observed total failures&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">nobs</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">posterior_total_failure_probability</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">observed_total_failures</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;P-values&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;coefficient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span>
        <span class="n">df_pval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Exog name&quot;</span><span class="p">})</span>
        <span class="n">display_dataframe</span><span class="p">(</span><span class="n">df_pval</span><span class="p">)</span>

        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Original output vs. Model output&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_model_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">uniform_noise</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">model_output</span> <span class="o">=</span> <span class="n">predict_statsmodels</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">U</span><span class="o">=</span><span class="n">uniform_noise</span><span class="p">,</span>
            <span class="n">inv_trafo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">,</span>
            <span class="n">noise_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;model_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_output</span>
        <span class="k">return</span> <span class="n">df_plot</span>

<div class="viewcode-block" id="ConvenientRegressionFit.plot_model_vs_original_histogram"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.plot_model_vs_original_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_model_vs_original_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots data sampled from the model and training data for comparison.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_size : float, optional</span>
<span class="sd">            Size of the bins.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Seed for the model prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_prediction</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xbins</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="nb">min</span><span class="p">([</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;model_output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_plot</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()]),</span>
            <span class="n">end</span><span class="o">=</span><span class="nb">max</span><span class="p">([</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;model_output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df_plot</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]),</span>
            <span class="n">size</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;original output&quot;</span><span class="p">,</span> <span class="n">xbins</span><span class="o">=</span><span class="n">xbins</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;model_output&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model output&quot;</span><span class="p">,</span> <span class="n">xbins</span><span class="o">=</span><span class="n">xbins</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;overlay&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Result </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_name</span><span class="si">}</span><span class="s2"> model vs. original output&quot;</span><span class="p">,</span>  <span class="c1"># title of plot</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvenientRegressionFit.print_model_summary"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientRegressionFit.print_model_summary">[docs]</a>    <span class="k">def</span> <span class="nf">print_model_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints a summary of the model and plots data sampled from the model vs the training data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_size : float, optional</span>
<span class="sd">            Size of the bins.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Seed for the model prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_model_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_model_vs_original_histogram</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConvenientOlsFit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientOlsFit">[docs]</a><span class="k">class</span> <span class="nc">ConvenientOlsFit</span><span class="p">(</span><span class="n">ConvenientRegressionFit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for ordinary least squares (OLS) regression models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    scenario_name : str</span>
<span class="sd">        Name of the scenario.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Regression formula.</span>
<span class="sd">    timestamp_input_data : str or None</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None</span>
<span class="sd">        Timestamp of the model export.</span>
<span class="sd">    total_failure_info : TotalFailureInfo or None</span>
<span class="sd">        Total failure info received from remove_invalid_sessions.</span>
<span class="sd">    inverse_output_trafo : Callable or None, optional</span>
<span class="sd">        Inverse output transformation of the SPV.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    noise_dist_family : st.rv_continuous</span>
<span class="sd">        Normal distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timestamp_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp_export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">total_failure_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TotalFailureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inverse_output_trafo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="n">timestamp_export</span><span class="p">,</span>
            <span class="n">total_failure_info</span><span class="o">=</span><span class="n">total_failure_info</span><span class="p">,</span>
            <span class="n">inverse_output_trafo</span><span class="o">=</span><span class="n">inverse_output_trafo</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">noise_dist_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_fit_noise_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_name</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">mse_resid</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="p">(</span><span class="o">*</span><span class="n">pars</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">100_000</span><span class="p">)</span>
                <span class="n">resids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">test_quantiles</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">resids</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">resids</span><span class="p">))):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1e-10 percentile of the fitted residual distribution: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1-1e-10 percentile of the fitted residual distribution: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">resids</span><span class="p">)):</span>
                    <span class="n">warn_msg</span> <span class="o">=</span> <span class="s2">&quot;Inf values occurred for the quantiles:&quot;</span>
                    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">test_quantiles</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">resids</span><span class="p">)]:</span>
                        <span class="n">warn_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">resids</span><span class="p">)):</span>
                    <span class="n">warn_msg</span> <span class="o">=</span> <span class="s2">&quot;NaN values occurred for the quantiles:&quot;</span>
                    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">test_quantiles</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">resids</span><span class="p">)]:</span>
                        <span class="n">warn_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some example percentile threw the following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_return_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">RegressionResultsWrapper</span><span class="p">]:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<div class="viewcode-block" id="ConvenientOlsFit.nongaussian_resid_fit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientOlsFit.nongaussian_resid_fit">[docs]</a>    <span class="k">def</span> <span class="nf">nongaussian_resid_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits custom distribution on the residuals of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dist : st.rv_continuous</span>
<span class="sd">            Custom distribution family to fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_noise_dist</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ConvenientGlmFit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientGlmFit">[docs]</a><span class="k">class</span> <span class="nc">ConvenientGlmFit</span><span class="p">(</span><span class="n">ConvenientRegressionFit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to fit generalized linear model (GLM) regressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    scenario_name : str</span>
<span class="sd">        Name of the scenario.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Regression formula.</span>
<span class="sd">    family : sm.genmod.families.family.Family</span>
<span class="sd">        Family of the noise distribution.</span>
<span class="sd">    total_failure_info : TotalFailureInfo or None</span>
<span class="sd">        Total failure info received from remove_invalid_sessions.</span>
<span class="sd">    timestamp_input_data : str or None</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None</span>
<span class="sd">        Timestamp of the model export.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    noise_dist_family : sm.genmod.families.family.Family</span>
<span class="sd">        Family of the noise distribution.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Do not use this class yet as it is in an experimental stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">family</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">genmod</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">Family</span><span class="p">,</span>
        <span class="n">total_failure_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TotalFailureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp_export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">total_failure_info</span><span class="o">=</span><span class="n">total_failure_info</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="n">timestamp_export</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">noise_dist_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_fit_noise_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># WARNING! This is not the noise dist, refactor!</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">resid_deviance</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">df_resid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">chi2</span><span class="p">(</span><span class="o">*</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_return_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">RegressionResultsWrapper</span><span class="p">]:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">resid_deviance</span>  <span class="c1"># todo refactor</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ConvenientMleFit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.ConvenientMleFit">[docs]</a><span class="k">class</span> <span class="nc">ConvenientMleFit</span><span class="p">(</span><span class="n">ConvenientRegressionFit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to fit a regression using the maximum likelihood estimator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    scenario_name : str</span>
<span class="sd">        Name of the scenario.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Regression formula.</span>
<span class="sd">    noise_dist : st.rv_continuous</span>
<span class="sd">        Family of the noise distribution.</span>
<span class="sd">    total_failure_info : TotalFailureInfo or None</span>
<span class="sd">        Total failure info received from remove_invalid_sessions.</span>
<span class="sd">    timestamp_input_data : str or None</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None</span>
<span class="sd">        Timestamp of the model export.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    noise_dist_family : st.rv_continuous</span>
<span class="sd">        Family of the noise distribution.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Do not use this class yet as it is in an experimental stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">noise_dist</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">,</span>
        <span class="n">total_failure_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TotalFailureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp_export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span> <span class="o">=</span> <span class="n">noise_dist</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">total_failure_info</span><span class="o">=</span><span class="n">total_failure_info</span><span class="p">,</span>
            <span class="n">timestamp_input_data</span><span class="o">=</span><span class="n">timestamp_input_data</span><span class="p">,</span>
            <span class="n">timestamp_export</span><span class="o">=</span><span class="n">timestamp_export</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">noise_dist_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;todo&quot;</span>

    <span class="k">def</span> <span class="nf">_return_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">RegressionResultsWrapper</span><span class="p">]:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">GenericLinearLikelihoodModel</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">noise_dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_family</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fit_noise_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">noise_params</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">noise_params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">noise_zero_mean</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span></div>


<div class="viewcode-block" id="GenericLinearLikelihoodModel"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.GenericLinearLikelihoodModel">[docs]</a><span class="k">class</span> <span class="nc">GenericLinearLikelihoodModel</span><span class="p">(</span><span class="n">GenericLikelihoodModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Do not use this class yet as it is in an experimental stage.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">exog</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">noise_dist</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># todo: rename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_type</span> <span class="o">=</span> <span class="n">noise_dist</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<div class="viewcode-block" id="GenericLinearLikelihoodModel.nloglikeobs"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.GenericLinearLikelihoodModel.nloglikeobs">[docs]</a>    <span class="k">def</span> <span class="nf">nloglikeobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
        <span class="n">dist_par</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="p">:]</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="n">dist_par</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">dist_par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_zero_mean</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ll</span></div>

<div class="viewcode-block" id="GenericLinearLikelihoodModel.noise_zero_mean"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.GenericLinearLikelihoodModel.noise_zero_mean">[docs]</a>    <span class="k">def</span> <span class="nf">noise_zero_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">st</span><span class="o">.</span><span class="n">_distn_infrastructure</span><span class="o">.</span><span class="n">rv_continuous_frozen</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choses location, so that mean=0&quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_type</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_type</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">-</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenericLinearLikelihoodModel.predict"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.GenericLinearLikelihoodModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">exog</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">pred_kwds_linear</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenericLinearLikelihoodModel.fit"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.GenericLinearLikelihoodModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">maxfun</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RegressionResultsWrapper</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_params</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compute approximate least squares fit</span>
            <span class="n">ols_result</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">params_ols_fit</span> <span class="o">=</span> <span class="n">ols_result</span><span class="o">.</span><span class="n">params</span>

            <span class="c1"># compute fit to residuals</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_dist_type</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ols_result</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># use both as start guess</span>
            <span class="n">params_dist</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
            <span class="c1"># The noise dist below will have set the location to zero, since it is considered in the intercept.</span>
            <span class="n">params_ols_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">loc</span>
            <span class="n">start_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params_ols_fit</span><span class="p">,</span> <span class="n">params_dist</span><span class="p">)</span>  <span class="c1"># add distribution&#39;s initial guess</span>

        <span class="c1"># add for summary</span>
        <span class="c1"># self.exog_names.append(&#39;shape&#39;)</span>
        <span class="c1"># self.exog_names.append(&#39;scale&#39;)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">start_params</span><span class="o">=</span><span class="n">start_params</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">maxfun</span><span class="o">=</span><span class="n">maxfun</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

        <span class="c1"># Build OLS-style result</span>
        <span class="c1"># Remark: This should all move to ConvenientMleFit to be aligned with GLM</span>
        <span class="n">result_ols_style</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">()</span>  <span class="c1"># Initialize an empty object, todo: namedtuple</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">predicted</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">fittedvalues</span> <span class="o">=</span> <span class="n">prediction</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">predict</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">resid</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">prediction</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">mse_resid</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">aic</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">aic</span>

        <span class="c1"># Isolate noise parameters</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span><span class="p">])</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">pvalues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span><span class="p">])</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">noise_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="p">:],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="p">:]</span>
        <span class="p">)</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">noise_pvalues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="p">:],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_beta</span> <span class="p">:]</span>
        <span class="p">)</span>

        <span class="c1"># result_ols_style.complete_noise_params = result.model.get_noise_dist()</span>

        <span class="k">def</span> <span class="nf">conf_int_data_frame</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="c1"># return panda data frame instead of matrix</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">=</span> <span class="n">conf_int_data_frame</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model</span>
        <span class="n">result_ols_style</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">summary</span>
        <span class="k">return</span> <span class="n">result_ols_style</span></div></div>


<span class="k">def</span> <span class="nf">_get_linearly_dependent_predictors</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">tolerance_linear_dependency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">null_space_matrix</span> <span class="o">=</span> <span class="n">null_space</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">linear_combinations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">null_space_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
        <span class="n">combination</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance_linear_dependency</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">combination</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2"> +&quot;</span>
        <span class="n">linear_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combination</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; +&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+ -&quot;</span><span class="p">,</span> <span class="s2">&quot;- &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = 0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">linear_combinations</span>


<div class="viewcode-block" id="backward_stepwise_selection"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.backward_stepwise_selection">[docs]</a><span class="k">def</span> <span class="nf">backward_stepwise_selection</span><span class="p">(</span><span class="n">base_model</span><span class="p">:</span> <span class="n">ConvenientRegressionFit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConvenientRegressionFit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Algorithm for removing statistically insignificant predictors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_model : ConvenientRegressionFit</span>
<span class="sd">        Model to remove predictors from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ConvenientRegressionFit</span>
<span class="sd">        Model without statistically insignificant predictors.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    get_polynomial_of_parameters_and_order : Generate a polynomial of a specific order for the parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    For further information see https://cc-github.bmwgroup.net/moritzwerling/reliability-engineering/tree/main/Model_Fits/tools/regression_models#backward-stepwise-selection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">number_of_predictors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base_model</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">number_of_predictors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Backward stepwise selection: The number of samples has to be greater than the number of predictors.&quot;</span>
        <span class="p">)</span>
    <span class="n">linear_combinations</span> <span class="o">=</span> <span class="n">_get_linearly_dependent_predictors</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Intercept&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">linear_combinations</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Some of the predictors are linearly dependent, which is not allowed in OLS regression. See:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">LINES_SEPARATOR</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">linear_combinations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">final_models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ConvenientRegressionFit</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">number_of_predictors</span><span class="p">:</span> <span class="n">base_model</span><span class="p">}</span>

    <span class="n">loocv_index</span> <span class="o">=</span> <span class="s2">&quot;LOOCV mean error&quot;</span>
    <span class="n">df_log</span> <span class="o">=</span> <span class="n">_create_log_dataframe</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">loocv_index</span><span class="p">)</span>
    <span class="n">df_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">number_of_predictors</span><span class="p">,</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;included&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">]</span>
    <span class="n">df_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">number_of_predictors</span><span class="p">,</span> <span class="n">loocv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">loocv</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_predictors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">final_models</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_best_model</span><span class="p">(</span><span class="n">final_models</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">df_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">final_models</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predictors</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;included&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">final_models</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predictors</span><span class="p">]</span>
        <span class="n">df_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loocv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_models</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loocv</span>

    <span class="k">def</span> <span class="nf">_get_color_for_bool</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;included&quot;</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;background-color: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">color</span>

    <span class="n">final_model_idx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_log</span><span class="p">[</span><span class="n">loocv_index</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># use reversed dataframe to get model with least predictors in case of a tie</span>
    <span class="n">df_log</span><span class="p">[</span><span class="n">loocv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_log</span><span class="p">[</span><span class="n">loocv_index</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.6e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span>
        <span class="n">df_log</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">_get_color_for_bool</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_predictors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;background-color: yellow; color: black&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[[</span><span class="n">loocv_index</span><span class="p">],</span> <span class="p">[</span><span class="n">final_model_idx</span><span class="p">]]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backward stepwise selection has chosen the model for k = </span><span class="si">{</span><span class="n">final_model_idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_models</span><span class="p">[</span><span class="n">final_model_idx</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_create_log_dataframe</span><span class="p">(</span><span class="n">base_model</span><span class="p">:</span> <span class="n">ConvenientRegressionFit</span><span class="p">,</span> <span class="n">loocv_index</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">number_of_predictors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">)</span>
    <span class="n">log_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">predictor</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;removed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">number_of_predictors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">}</span>
    <span class="n">log_data</span><span class="p">[</span><span class="n">loocv_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_predictors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">log_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_predictors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">predictors</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_best_model</span><span class="p">(</span><span class="n">last_model</span><span class="p">:</span> <span class="n">ConvenientRegressionFit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConvenientRegressionFit</span><span class="p">:</span>
    <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConvenientRegressionFit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="n">last_model</span><span class="o">.</span><span class="n">predictors</span><span class="p">:</span>
        <span class="n">is_predictor_hierarchically_dependent</span> <span class="o">=</span> <span class="n">ConvenientRegressionFit</span><span class="o">.</span><span class="n">is_predictor_hierarchically_dependent</span><span class="p">(</span>
            <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span> <span class="n">predictors</span><span class="o">=</span><span class="n">last_model</span><span class="o">.</span><span class="n">predictors</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_predictor_hierarchically_dependent</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">last_model</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">drop_term</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">rsquared</span><span class="p">)</span>


<div class="viewcode-block" id="full_run"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.full_run">[docs]</a><span class="k">def</span> <span class="nf">full_run</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">noise_dist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">rv_continuous</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">total_failure_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TotalFailureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timestamp_input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timestamp_export</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">get_now_string</span><span class="p">(),</span>
    <span class="n">drop_terms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">run_find_best_fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">number_of_printed_outliers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">print_outlier_session_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConvenientOlsFit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates and fits an OLS model and prints and plots information regarding the model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        DataFrame of training data.</span>
<span class="sd">    formula : str</span>
<span class="sd">        Regression formula.</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the model.</span>
<span class="sd">    scenario_name : str</span>
<span class="sd">        Name of the scenario.</span>
<span class="sd">    noise_dist : st.rv_continuous or None, optional</span>
<span class="sd">        Distribution family to fit the noise.</span>
<span class="sd">    total_failure_info : TotalFailureInfo or None, optional</span>
<span class="sd">        Total failure info received from remove_invalid_sessions.</span>
<span class="sd">    timestamp_input_data : str or None, optional</span>
<span class="sd">        Timestamp of the input data.</span>
<span class="sd">    timestamp_export : str or None, optional</span>
<span class="sd">        Timestamp of the model export.</span>
<span class="sd">    drop_terms : List[str], optional</span>
<span class="sd">        Terms to drop from the model.</span>
<span class="sd">    run_find_best_fit : bool, optional</span>
<span class="sd">        Wether to find the best fit for the residuals.</span>
<span class="sd">    number_of_printed_outliers : int, optional</span>
<span class="sd">        Number of outliers to be printed.</span>
<span class="sd">    print_outlier_session_ids : bool, optional</span>
<span class="sd">        Wether to print the outlier session ids.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ConvenientOlsFit</span>
<span class="sd">        The fitted model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">ConvenientOlsFit</span><span class="p">(</span>
        <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="n">total_failure_info</span><span class="o">=</span><span class="n">total_failure_info</span><span class="p">,</span>
        <span class="n">timestamp_input_data</span><span class="o">=</span><span class="n">timestamp_input_data</span><span class="p">,</span>
        <span class="n">timestamp_export</span><span class="o">=</span><span class="n">timestamp_export</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">drop_terms</span><span class="p">:</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">drop_term</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropped terms: </span><span class="si">{</span><span class="n">drop_terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Performed backward stepwise selection:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">backward_stepwise_selection</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Regression summary:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Residuals:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">run_find_best_fit</span><span class="p">:</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Best fit for residuals:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">find_best_fit</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">noise_dist</span><span class="p">:</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performed nongaussian resid fit on distribution: </span><span class="si">{</span><span class="n">noise_dist</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">nongaussian_resid_fit</span><span class="p">(</span><span class="n">noise_dist</span><span class="p">)</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;QQ-Plots:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">resid_qqplot</span><span class="p">()</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Partial regression plots:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">plot_partregress_grid</span><span class="p">()</span>
    <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Component-component plus residual plots:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">plot_ccpr_grid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">print_outlier_session_ids</span><span class="p">:</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Outlier session ids:&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">print_outlier_session_ids</span><span class="p">(</span><span class="n">number_of_printed_outliers</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">print_model_summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fit</span></div>


<div class="viewcode-block" id="get_polynomial_of_parameters_and_order"><a class="viewcode-back" href="../../regression_models.html#regression_models.regression_models.get_polynomial_of_parameters_and_order">[docs]</a><span class="k">def</span> <span class="nf">get_polynomial_of_parameters_and_order</span><span class="p">(</span><span class="n">parameters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a polynomial of a specific order for the parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : List[str]</span>
<span class="sd">        Parameters for the polynomial.</span>
<span class="sd">    order : int</span>
<span class="sd">        Order of the polynomial.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The generated polynomial.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The order of the polynomial as to be greater than 1. Given </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">all_combinations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">all_combinations</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">all_combinations</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Team Kepler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, Bayerische Motoren Werke Aktiengesellschaft (BMW AG).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>