<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>comparison_tools.model_comparison &mdash; Model Fits Tools  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Model Fits Tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Model Fits Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">comparison_tools.model_comparison</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for comparison_tools.model_comparison</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (C) 2024, Bayerische Motoren Werke Aktiengesellschaft (BMW AG)</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.figure_factory</span> <span class="k">as</span> <span class="nn">ff</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">statsmodels.distributions.empirical_distribution</span> <span class="kn">import</span> <span class="n">ECDF</span>
<span class="kn">from</span> <span class="nn">tools.comparison_tools.divergence_metrics</span> <span class="kn">import</span> <span class="n">emd</span><span class="p">,</span> <span class="n">empirical_js_divergence</span><span class="p">,</span> <span class="n">ks_test</span><span class="p">,</span> <span class="n">mse</span>
<span class="kn">from</span> <span class="nn">tools.general_utility.custom_eval</span> <span class="kn">import</span> <span class="n">evaluate_formula</span>
<span class="kn">from</span> <span class="nn">tools.general_utility.helpers</span> <span class="kn">import</span> <span class="n">display_dataframe</span><span class="p">,</span> <span class="n">display_markdown</span>
<span class="kn">from</span> <span class="nn">tools.models_export.statsmodels_exporter</span> <span class="kn">import</span> <span class="n">SpmModel</span>
<span class="kn">from</span> <span class="nn">tools.regression_models.regression_helpers</span> <span class="kn">import</span> <span class="n">predict_statsmodels</span>
<span class="kn">from</span> <span class="nn">tools.regression_models.regression_models</span> <span class="kn">import</span> <span class="n">ConvenientRegressionFit</span>


<div class="viewcode-block" id="ComparisonInformation"><a class="viewcode-back" href="../../comparison_tools.html#comparison_tools.model_comparison.ComparisonInformation">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ComparisonInformation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper containing information about the compared models.&quot;&quot;&quot;</span>

    <span class="n">model_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The names of the compared models.&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The predictions of the compared models on the training data.&quot;&quot;&quot;</span>
    <span class="n">ecdfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ECDF</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The empirical cumulative distribution functions of the predictions of the compared models on the training data.&quot;&quot;&quot;</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A title for the comparison.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ModelComparison"><a class="viewcode-back" href="../../comparison_tools.html#comparison_tools.model_comparison.ModelComparison">[docs]</a><span class="k">class</span> <span class="nc">ModelComparison</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare two iterations of a model to decide whether it needs to be updated in MCS.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    new_model : ConvenientRegressionFit</span>
<span class="sd">        The new model.</span>
<span class="sd">    path_old_model : str</span>
<span class="sd">        The path to the json file describing the old model.</span>
<span class="sd">    inverse_output_trafo : Callable or None, optional</span>
<span class="sd">        The inverse of the transformation of the explained variable</span>
<span class="sd">        (i.e. if our model was ln(y) ~ x, the inverse_output_trafo would be math.exp)</span>
<span class="sd">    seed : int or None, optional</span>
<span class="sd">        A seed used to sample the noise when generating predictions of the models.</span>
<span class="sd">    name_new_model : str, optional</span>
<span class="sd">        A name for the new model. The tool will use this name to refer to the new model in plots.</span>
<span class="sd">    name_old_model : str, optional</span>
<span class="sd">        A name for the old model. The tool will use this name to refer to the old model in plots.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    new_model : ConvenientRegressionFit</span>
<span class="sd">        The new model.</span>
<span class="sd">    old_model : SpmModel</span>
<span class="sd">        The old model.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        The training data of the new model.</span>
<span class="sd">    y_observed : pd.Series</span>
<span class="sd">        The ground-truth values of the explained variable in the training data of the new model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_model</span><span class="p">:</span> <span class="n">ConvenientRegressionFit</span><span class="p">,</span>
        <span class="n">path_old_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">inverse_output_trafo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span>
        <span class="n">name_new_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;New model&quot;</span><span class="p">,</span>
        <span class="n">name_old_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Old model&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_model</span> <span class="o">=</span> <span class="n">new_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span> <span class="o">=</span> <span class="n">SpmModel</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">path_old_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_output_trafo</span> <span class="o">=</span> <span class="n">inverse_output_trafo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uniform_noise</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regression_formula</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">response_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span> <span class="o">=</span> <span class="n">name_new_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span> <span class="o">=</span> <span class="n">name_old_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_transformation_of_dependent_variable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_transformation_of_dependent_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">supported_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;np\.\w+\((\w+)\s*,\s*\d+\)&quot;</span><span class="p">),</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;np\.\w+\((\w+)\)&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">supported_patterns</span><span class="p">:</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">dependent_variable</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">matches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_output_trafo</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The dependent variable has been transformed and no inverse transformation has been given. The Regression output will correspond to the transformed variable!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_output_trafo</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An inverse output transformation was given but no transformation of the dependent variable </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s2"> was detected. At the moment, only the transformations of the type np.(...) are recognized. In case the dependent variable was transformed by a different function and the correct inverse transformation has been given, this warning can be ignored.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_ifv_in_model_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_param</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">model_param</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">colname</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching column found in the data for old model parameter </span><span class="si">{</span><span class="n">model_param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_parameters_with_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">categorical_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">category_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[T\.(.*?)\]&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;Intercept&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">single_param</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="n">ifv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_ifv_in_model_param</span><span class="p">(</span><span class="n">single_param</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">category_pattern</span><span class="p">,</span> <span class="n">single_param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">categorical_params</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">ifv</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">categorical_params</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">ifv</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">categorical_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_formula_from_parameter_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">standard_replace_pattern</span> <span class="o">=</span> <span class="s2">&quot;df[&#39;</span><span class="si">{param}</span><span class="s2">&#39;]&quot;</span>
        <span class="n">categorical_replace_pattern</span> <span class="o">=</span> <span class="s2">&quot;(df[&#39;</span><span class="si">{param}</span><span class="s2">&#39;]==&#39;</span><span class="si">{category}</span><span class="s2">&#39;)&quot;</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">])]</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; * &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> * </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;Intercept&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters_with_categories</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">standard_replace_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">[T.</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">categorical_replace_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regression_formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="k">return</span> <span class="n">formula</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">old_model_result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pd.Series : The predictions of the old model on the training data of the new model.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_formula_from_parameter_list</span><span class="p">(),</span> <span class="n">subscriptable_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">}</span>
        <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">get_noise_distribution</span><span class="p">()</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uniform_noise</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_output_trafo</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_output_trafo</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">new_model_result</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;pd.Series : The predictions of the new model on its training data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">predict_statsmodels</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">U</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_uniform_noise</span><span class="p">,</span>
            <span class="n">inv_trafo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">inverse_output_trafo</span><span class="p">,</span>
            <span class="n">noise_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">noise_dist</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ModelComparison.compare_predictions"><a class="viewcode-back" href="../../comparison_tools.html#comparison_tools.model_comparison.ModelComparison.compare_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">compare_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Displays histogram plots of the predictions of both models on the training data of the new model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bin_size : float, optional</span>
<span class="sd">            The desired width of the histogram bins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Distplot: Compare predictions of the models&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">create_distplot</span><span class="p">(</span>
            <span class="n">hist_data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_observed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_result</span><span class="p">],</span>
            <span class="n">group_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Original output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span><span class="p">],</span>
            <span class="n">bin_size</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span>
            <span class="n">show_hist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">show_rug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">curve_type</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">response_name</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Used regression formula parsed from the input file (not including inverse output transformation if given): </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_regression_formula</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelComparison.compare_params"><a class="viewcode-back" href="../../comparison_tools.html#comparison_tools.model_comparison.ModelComparison.compare_params">[docs]</a>    <span class="k">def</span> <span class="nf">compare_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Displays a tabular comparison of the model parameters.&quot;&quot;&quot;</span>
        <span class="n">cm_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bm_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Comparison of model parameters&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">display_dataframe</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                        <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bm_keys</span> <span class="o">&amp;</span> <span class="n">cm_keys</span>
                        <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bm_keys</span> <span class="o">|</span> <span class="n">cm_keys</span>
                <span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span><span class="p">,</span> <span class="s2">&quot;Absolute Difference&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">style_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text-align&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="n">table_styles</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;selector&quot;</span><span class="p">:</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">)]}],</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_comparison_information_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ComparisonInformation</span><span class="p">]:</span>
        <span class="n">model_information</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;ecdf&quot;</span><span class="p">:</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span><span class="p">,</span> <span class="s2">&quot;Actual observations&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_observed</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ComparisonInformation</span><span class="p">(</span>
                <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">model_information</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">],</span>
                <span class="n">ecdfs</span><span class="o">=</span><span class="p">[</span><span class="n">model_information</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;ecdf&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">],</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;Actual observations&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_new_model</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;Actual observations&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_old_model</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">]</span>

<div class="viewcode-block" id="ModelComparison.model_similarity_quantities"><a class="viewcode-back" href="../../comparison_tools.html#comparison_tools.model_comparison.ModelComparison.model_similarity_quantities">[docs]</a>    <span class="k">def</span> <span class="nf">model_similarity_quantities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbins_for_distribution_discretization</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Displays different model similarity metrics in a tabular fashion. Also plots the empirical cumulative</span>
<span class="sd">        distribution functions together with the Kolmogorov-Smirnov test statistic.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nbins_for_distribution_discretization : int, optional</span>
<span class="sd">            The number of bins to be used to calculate the Jensen-Shannon divergence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Quantities indicating model similarity or lack of similarity&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">comparison_information_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_comparison_information_list</span><span class="p">()</span>
        <span class="n">ks_test_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">ks_test</span><span class="p">(</span><span class="o">*</span><span class="n">comparison</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparison_information_list</span><span class="p">]</span>
        <span class="n">display_dataframe</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;MSE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">mse</span><span class="p">(</span><span class="o">*</span><span class="n">comparison</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparison_information_list</span><span class="p">],</span>
                    <span class="s2">&quot;EMD&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">emd</span><span class="p">(</span><span class="o">*</span><span class="n">comparison</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparison_information_list</span><span class="p">],</span>
                    <span class="s2">&quot;JS-Divergence&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">empirical_js_divergence</span><span class="p">(</span><span class="o">*</span><span class="n">comparison</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="n">nbins_for_distribution_discretization</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparison_information_list</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;KS test statistic&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">statistic</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ks_test_results</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">comparison</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">comparison_information_list</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Notes: </span><span class="se">\n</span><span class="s2"> 1) JS divergence is calculated from a discretized distribution </span><span class="se">\n</span><span class="s2"> 2) The KS test column shows the </span><span class="se">\033</span><span class="s2">[1mtest statistic</span><span class="se">\033</span><span class="s2">[0m of the Kolmogorov-Smirnov hypothesis test. The KS test statistic can be interpreted as the highest possible deviation between the two empirical cumulative distribution functions of the provided data, see figures below. As such, it can take values ranging from 0 (models are identical) to 1 (not similar at all).&quot;</span>
        <span class="p">)</span>

        <span class="n">display_markdown</span><span class="p">(</span><span class="s2">&quot;Empirical CDF plots with KS test statistic&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">comparison</span><span class="p">,</span> <span class="n">ks_result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">comparison_information_list</span><span class="p">,</span> <span class="n">ks_test_results</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ecdf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">ecdfs</span><span class="p">,</span> <span class="n">comparison</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">comparison</span><span class="o">.</span><span class="n">model_names</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ecdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ecdf_val</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">ecdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">ks_result</span><span class="o">.</span><span class="n">statistic_location</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">ks_result</span><span class="o">.</span><span class="n">statistic_location</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">[</span><span class="n">ecdf_val</span><span class="p">,</span> <span class="n">ecdf_val</span> <span class="o">-</span> <span class="n">ks_result</span><span class="o">.</span><span class="n">statistic_sign</span> <span class="o">*</span> <span class="n">ks_result</span><span class="o">.</span><span class="n">statistic</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;KS test statistic&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_model</span><span class="o">.</span><span class="n">dependent_variable</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Bayerische Motoren Werke Aktiengesellschaft (BMW AG).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>